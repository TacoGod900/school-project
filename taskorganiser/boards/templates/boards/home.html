{% extends 'layout.html' %}

{% load static %}
{% block title %}My Boards{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'boards/style.css' %}">
{% endblock %}

{% block content %}
<div class="home-container">
  <div class="home-header">
    <h1 class="home-title">{{ user.username }}!</h1>
    <a href="{% url 'logout' %}" class="btn-logout">Logout</a>
  </div>

  <button id='create-board-button' class="btn-create-board">
    + New Board
  </button>
  
  <div id="boards-list" class="boards-grid">
    {% for board in boards %}
      <div class="board-card" onclick="window.location.href='/board/{{ board.id }}/'">
        <h3>{{ board.name }}</h3>
        <p>{{ board.description }}</p>
        <small>Created: {{ board.created_at|date:"M d, Y" }}</small>
      </div>
    {% empty %}
      <p style="color: #666666; grid-column: 1 / -1; font-size: 16px;">No boards yet. Create one to get started!</p>
    {% endfor %}
  </div>
</div>

<div id="createBoardModal" class="modal">
  <div class="modal-content">
    <h2 class="modal-title">Create New Board</h2>
    <form id="createBoardForm">
      <div class="form-group">
        <label for="boardName" class="form-label">Board Name</label>
        <input type="text" id="boardName" placeholder="e.g., Personal Tasks">
      </div>
      
      <div class="form-group">
        <label for="boardDescription" class="form-label">Description</label>
        <textarea id="boardDescription" placeholder="Add a description for your board..."></textarea>
      </div>

      <div class="modal-buttons">
        <button type="button" id="cancelCreateBoard" class="btn-cancel">Cancel</button>
        <button type="submit" id="confirmCreateBoard" class="btn-submit">Create Board</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script>
    // this gets the csrf token from cookies so we can send stuff to django
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // when you click the create board button
    document.getElementById('create-board-button').addEventListener('click', function() {
      // show the popup
      document.getElementById('createBoardModal').classList.add('active');
    });

    // when you click cancel
    document.getElementById('cancelCreateBoard').addEventListener('click', function() {
      // hide the popup
      document.getElementById('createBoardModal').classList.remove('active');
    });

    // when you submit the form
    document.getElementById('createBoardForm').addEventListener('submit', function(e) {
      // stop the page from reloading
      e.preventDefault();
      
      const csrftoken = getCookie('csrftoken');
      const boardName = document.getElementById('boardName').value;
      const boardDescription = document.getElementById('boardDescription').value;
      const url = '/board/create/';
      
      // put the form data into a string
      const data = JSON.stringify({
        name: boardName,
        description: boardDescription
      });
      
      // send it to the server
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: data
      })
      .then(function(response) {
        // turn the response into usable data
        return response.json();
      })
      .then(function(json) { 
        // go to the new board page
        window.location.href = json.redirect_url;
      });
    });
  </script>
{% endblock %}
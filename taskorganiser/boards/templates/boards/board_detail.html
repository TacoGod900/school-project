{% extends "layout.html" %}
{% load static %}
{% block title %}{{ board.name }}{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'boards/style.css' %}">
  <style>
    body {
      {% if board.background_image %}
        background-image: url({{ board.background_image.url }});
      {% else %}
        background-image: url({% static 'images/background-default.jpg' %});
      {% endif %}
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
  </style>
{% endblock %}

{% block content %}
<div class="main-content">
  <div class="board-header">
    <div>
      <h1 id="boardName">{{ board.name }}<button id="editBoardBtn" class="btn-edit-board">✎</button></h1>
      <p>{{ board.description }}</p>
    </div>
  </div>

  <button id="newGroup" class="newgroupbtn">new group</button>

  <div id="bigSort">
    {% for group in groups %}
      <div class="big-container" data-group-id="{{ group.id }}">
        <h3>
          <span class="group-name" data-group-id="{{ group.id }}">{{ group.name }}</span>
          <button class="btn-add-new-todo">new</button>
        </h3>
        <ul class="small-list">
          {% for task in group.tasks.all %}
            <li data-task-id="{{ task.id }}">
              <input type="checkbox" class="task-checkbox" {% if task.completed %}checked{% endif %}>
              <span class="task-text">{{ task.content }}</span>
            </li>
          {% empty %}
          {% endfor %}
        </ul>
      </div>
    {% empty %}
    {% endfor %}
  </div>
</div>

<!-- Edit thing -->
<div class="editthing-overlay" id="editThing">
  <div class="editthing-content">
    <h2>Edit</h2>
    <textarea id="editTextarea"></textarea>
    <div class="modal-buttons">
      <button id="deleteBtn" class="btn-delete">Delete</button>
      <button id="cancelBtn" class="btn-edit-cancel">Cancel</button>
      <button id="saveBtn" class="btn-save">Save</button>
    </div>
  </div>
</div>

<!-- Board Settings Modal -->
<div class="editthing-overlay" id="boardSettingsModal">
  <div class="editthing-content">
    <h2>Board Settings</h2>
    <form id="boardSettingsForm" enctype="multipart/form-data">
      <div style="margin-bottom: 16px;">
        <label style="display: block; color: #333; margin-bottom: 8px;">Board Name</label>
        <input type="text" id="boardNameInput" name="name" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; color: #333; background: white;">
      </div>
      <div style="margin-bottom: 16px;">
        <label style="display: block; color: #333; margin-bottom: 8px;">Background Image</label>
        <input type="file" id="boardBgInput" name="background_image" accept="image/*" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; color: #333; background: white;">
        <small style="display: block; margin-top: 4px; color: #666;">Upload an image from your device</small>
      </div>
      <div class="modal-buttons">
        <button type="button" id="boardCancelBtn" class="btn-edit-cancel">Cancel</button>
        <button type="button" id="boardSaveBtn" class="btn-save">Save</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script>
    // get the board id from django
    const boardId = {{ board.id }};
    
    // keep track of what item we are editing
    let currentEditingItem = null;

    // this gets the csrf token from cookies so we can send data to django
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // make the big group containers draggable side to side
    new Sortable(document.getElementById('bigSort'), { 
      animation:150, 
      handle:'h3', 
      direction:'horizontal' 
    });

    // make a list draggable up and down
    function initSortableList(list) {
      new Sortable(list, { 
        animation:150, 
        direction:'vertical' 
      });
    }

    // make all the existing task lists draggable
    const allLists = document.querySelectorAll('.small-list');
    for (let i = 0; i < allLists.length; i++) {
      initSortableList(allLists[i]);
    }

    // when you click a task text it opens the edit popup
    function attachTaskClickHandler(item) {
      const taskText = item.querySelector('.task-text');
      taskText.addEventListener('click', function() {
        currentEditingItem = item;
        document.getElementById('editTextarea').value = taskText.textContent.trim();
        document.getElementById('editThing').classList.add('active');
      });
    }

    // add click handlers to all existing tasks
    const allTaskItems = document.querySelectorAll('.small-list li');
    for (let i = 0; i < allTaskItems.length; i++) {
      attachTaskClickHandler(allTaskItems[i]);
    }

    // when you check or uncheck a box it saves to the server
    function attachCheckboxHandler(checkbox) {
      checkbox.addEventListener('change', function(e) {
        const taskId = checkbox.closest('li').dataset.taskId;
        const csrftoken = getCookie('csrftoken');
        const url = '/task/' + taskId + '/toggle/';
        const data = JSON.stringify({ completed: e.target.checked });
        
        // send the checked status to server
        fetch(url, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            'X-CSRFToken': csrftoken 
          },
          body: data
        });
      });
    }

    // add checkbox handlers to all existing checkboxes
    const allCheckboxes = document.querySelectorAll('.task-checkbox');
    for (let i = 0; i < allCheckboxes.length; i++) {
      attachCheckboxHandler(allCheckboxes[i]);
    }

    // when you click a group name you can rename it
    function attachGroupNameClickHandler(groupNameEl) {
      groupNameEl.addEventListener('click', function() {
        const currentName = groupNameEl.textContent.trim();
        const groupId = groupNameEl.dataset.groupId;
        const newName = prompt('Enter new group name:', currentName);
        
        // if they typed something, send it to server
        if (newName && newName.trim()) {
          const csrftoken = getCookie('csrftoken');
          const url = '/group/' + groupId + '/update/';
          const data = JSON.stringify({ name: newName.trim() });
          
          fetch(url, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json', 
              'X-CSRFToken': csrftoken 
            },
            body: data
          })
          .then(function(response) {
            // turn the response into usable data
            return response.json();
          })
          .then(function(json) { 
            // update the group name on the page
            groupNameEl.textContent = json.group_name;
          });
        }
      });
    }

    // add click handlers to all group names
    const allGroupNames = document.querySelectorAll('.group-name');
    for (let i = 0; i < allGroupNames.length; i++) {
      attachGroupNameClickHandler(allGroupNames[i]);
    }

    // when you click save in the edit popup
    document.getElementById('saveBtn').addEventListener('click', function() {
      const taskId = currentEditingItem.dataset.taskId;
      const content = document.getElementById('editTextarea').value.trim();
      const taskText = currentEditingItem.querySelector('.task-text');
      const csrftoken = getCookie('csrftoken');
      const url = '/task/' + taskId + '/update/';
      const data = JSON.stringify({ content: content });
      
      // send the new text to the server
      fetch(url, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'X-CSRFToken': csrftoken 
        },
        body: data
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(json) { 
        // update the text on the page
        taskText.textContent = content;
      });
      
      // close the popup
      document.getElementById('editThing').classList.remove('active');
    });

    // when you click cancel in the edit popup
    document.getElementById('cancelBtn').addEventListener('click', function() {
      document.getElementById('editThing').classList.remove('active');
    });

    // when you click delete in the edit popup
    document.getElementById('deleteBtn').addEventListener('click', function() {
      const taskId = currentEditingItem.dataset.taskId;
      const csrftoken = getCookie('csrftoken');
      const url = '/task/' + taskId + '/delete/';
      
      // tell the server to delete this task
      fetch(url, {
        method: 'POST',
        headers: { 
          'X-CSRFToken': csrftoken 
        }
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(json) { 
        // remove it from the page
        currentEditingItem.remove();
      });
      
      // close the popup
      document.getElementById('editThing').classList.remove('active');
    });

    // when you click the new button on a group
    function attachNewTaskHandler(button) {
      button.addEventListener('click', function() {
        const groupId = button.closest('.big-container').dataset.groupId;
        const smallList = button.closest('.big-container').querySelector('.small-list');
        const csrftoken = getCookie('csrftoken');
        const url = '/group/' + groupId + '/task/create/';
        const data = JSON.stringify({ content: 'New Item' });
        
        // tell the server to make a new task
        fetch(url, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            'X-CSRFToken': csrftoken 
          },
          body: data
        })
        .then(function(response) {
          return response.json();
        })
        .then(function(json) {
          // make a new task element
          const newItem = document.createElement('li');
          newItem.innerHTML = '<input type="checkbox" class="task-checkbox"><span class="task-text">' + json.task_content + '</span>';
          newItem.dataset.taskId = json.task_id;
          
          // add it to the list
          smallList.appendChild(newItem);
          
          // make it clickable and checkable
          attachTaskClickHandler(newItem);
          attachCheckboxHandler(newItem.querySelector('.task-checkbox'));
        });
      });
    }

    // add handlers to all existing new task buttons
    const allNewTaskButtons = document.querySelectorAll('.btn-add-new-todo');
    for (let i = 0; i < allNewTaskButtons.length; i++) {
      attachNewTaskHandler(allNewTaskButtons[i]);
    }

    // when you click the new group button
    document.getElementById('newGroup').addEventListener('click', function() {
      const groupCount = document.getElementById('bigSort').querySelectorAll('.big-container').length + 1;
      const csrftoken = getCookie('csrftoken');
      const url = '/board/' + boardId + '/group/create/';
      const data = JSON.stringify({ name: 'Group ' + groupCount });
      
      // tell the server to make a new group
      fetch(url, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'X-CSRFToken': csrftoken 
        },
        body: data
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(json) {
        // make a new group container
        const newBigContainer = document.createElement('div');
        newBigContainer.classList.add('big-container');
        newBigContainer.dataset.groupId = json.group_id;
        newBigContainer.innerHTML = '<h3><span class="group-name" data-group-id="' + json.group_id + '">' + json.group_name + '</span><button class="btn-add-new-todo">new</button></h3><ul class="small-list"></ul>';
        
        // add it to the page
        document.getElementById('bigSort').appendChild(newBigContainer);
        
        // make the new list draggable
        initSortableList(newBigContainer.querySelector('.small-list'));
        
        // make the buttons work
        attachNewTaskHandler(newBigContainer.querySelector('.btn-add-new-todo'));
        attachGroupNameClickHandler(newBigContainer.querySelector('.group-name'));
      });
    });

    // when you click the edit board button
    document.getElementById('editBoardBtn').addEventListener('click', function() {
      // put the current board name in the input
      document.getElementById('boardNameInput').value = document.getElementById('boardName').textContent.trim().replace('✎', '').trim();
      document.getElementById('boardBgInput').value = '';
      
      // show the popup
      document.getElementById('boardSettingsModal').classList.add('active');
    });

    // when you click cancel on board settings
    document.getElementById('boardCancelBtn').addEventListener('click', function() {
      document.getElementById('boardSettingsModal').classList.remove('active');
    });

    // when you click save on board settings
    document.getElementById('boardSaveBtn').addEventListener('click', function() {
      const formData = new FormData();
      const name = document.getElementById('boardNameInput').value.trim();
      const fileInput = document.getElementById('boardBgInput');
      const csrftoken = getCookie('csrftoken');
      const url = '/board/' + boardId + '/update/';
      
      // add the board name to the form
      formData.append('name', name);
      
      // if they picked a file, add it too
      if (fileInput.files.length > 0) {
        formData.append('background_image', fileInput.files[0]);
      }
      
      // send it to the server
      fetch(url, {
        method: 'POST',
        headers: { 
          'X-CSRFToken': csrftoken 
        },
        body: formData
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(json) {
        // update the board name on the page
        const boardNameEl = document.getElementById('boardName');
        boardNameEl.childNodes[0].textContent = json.board_name;
        
        // if they uploaded a new background, update it
        if (json.background_image) {
          document.body.style.backgroundImage = 'url(' + json.background_image + ')';
          document.body.style.backgroundSize = 'cover';
          document.body.style.backgroundPosition = 'center';
          document.body.style.backgroundAttachment = 'fixed';
        }
        
        // close the popup and clear the form
        document.getElementById('boardSettingsModal').classList.remove('active');
        document.getElementById('boardSettingsForm').reset();
      });
    });
  </script>
{% endblock %}
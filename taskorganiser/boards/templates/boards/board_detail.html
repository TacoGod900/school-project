{% extends "layout.html" %}
{% load static %}
{% block title %}{{ board.name }}{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'boards/style.css' %}">
  <style>
    body {
      background-image: url({% static board.background_image %});
    }
  </style>
{% endblock %}

{% block content %}
<div class="main-content">
  <div class="board-header">
    <div>
      <h1 id="boardName">{{ board.name }}<button id="editBoardBtn" class="btn-edit-board">✎</button></h1>
      <p>{{ board.description }}</p>
    </div>
  </div>

  <button id="newGroup" class="newgroupbtn">new group</button>

  <div id="bigSort">
    {% for group in groups %}
      <div class="big-container" data-group-id="{{ group.id }}">
        <h3>{{ group.name }}<button class="btn-add-new-todo">new</button></h3>
        <ul class="small-list">
          {% for task in group.tasks.all %}
            <li data-task-id="{{ task.id }}">
              <input type="checkbox" class="task-checkbox" {% if task.completed %}checked{% endif %}>
              <span class="task-text">{{ task.content }}</span>
            </li>
          {% empty %}
          {% endfor %}
        </ul>
      </div>
    {% empty %}
    {% endfor %}
  </div>
</div>

<!-- Edit thing -->
<div class="editthing-overlay" id="editThing">
  <div class="editthing-content">
    <h2>Edit</h2>
    <textarea id="editTextarea"></textarea>
    <div class="modal-buttons">
      <button id="deleteBtn" class="btn-delete">Delete</button>
      <button id="cancelBtn" class="btn-edit-cancel">Cancel</button>
      <button id="saveBtn" class="btn-save">Save</button>
    </div>
  </div>
</div>

<!-- Board Settings Modal -->
<div class="editthing-overlay" id="boardSettingsModal">
  <div class="editthing-content">
    <h2>Board Settings</h2>
    <div style="margin-bottom: 16px;">
      <label style="display: block; color: #333; margin-bottom: 8px;">Board Name</label>
      <input type="text" id="boardNameInput" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; color: #333; background: white;">
    </div>
    <div style="margin-bottom: 16px;">
      <label style="display: block; color: #333; margin-bottom: 8px;">Background Image Path</label>
      <input type="text" id="boardBgInput" placeholder="e.g., images/background-default.jpg" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; color: #333; background: white;">
    </div>
    <div class="modal-buttons">
      <button id="boardCancelBtn" class="btn-edit-cancel">Cancel</button>
      <button id="boardSaveBtn" class="btn-save">Save</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script>
    const boardId = {{ board.id }};
    let currentEditingItem = null;

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    new Sortable(document.getElementById('bigSort'), { animation:150, handle:'h3', direction:'horizontal' });

    function initSortableList(list) {
      new Sortable(list, { animation:150, direction:'vertical' });
    }

    document.querySelectorAll('.small-list').forEach(list => initSortableList(list));

    function attachTaskClickHandler(item) {
      const taskText = item.querySelector('.task-text');
      if (taskText) {
        taskText.addEventListener('click', () => {
          currentEditingItem = item;
          document.getElementById('editTextarea').value = taskText.textContent.trim();
          document.getElementById('editThing').classList.add('active');
        });
      }
    }

    document.querySelectorAll('.small-list li').forEach(item => attachTaskClickHandler(item));

    // Checkbox
    function attachCheckboxHandler(checkbox) {
      checkbox.addEventListener('change', (e) => {
        const taskId = checkbox.closest('li').dataset.taskId;
        if (taskId) {
          fetch(`/task/${taskId}/toggle/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ completed: e.target.checked })
          })
          .then(r => r.json())
          .then(d => { if (!d.success) e.target.checked = !e.target.checked; });
        }
      });
    }

    document.querySelectorAll('.task-checkbox').forEach(checkbox => attachCheckboxHandler(checkbox));

    document.getElementById('saveBtn').addEventListener('click', () => {
      const taskId = currentEditingItem.dataset.taskId;
      const content = document.getElementById('editTextarea').value.trim();
      const taskText = currentEditingItem.querySelector('.task-text');
      if (taskId) {
        fetch(`/task/${taskId}/update/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          body: JSON.stringify({ content: content })
        })
        .then(r => r.json())
        .then(d => { if (d.success && taskText) taskText.textContent = content; });
      } else {
        if (taskText) taskText.textContent = content;
      }
      document.getElementById('editThing').classList.remove('active');
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
      document.getElementById('editThing').classList.remove('active');
    });

    document.getElementById('deleteBtn').addEventListener('click', () => {
      const taskId = currentEditingItem.dataset.taskId;
      if (taskId) {
        fetch(`/task/${taskId}/delete/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(r => r.json())
        .then(d => { if (d.success) currentEditingItem.remove(); });
      } else {
        currentEditingItem.remove();
      }
      document.getElementById('editThing').classList.remove('active');
    });

    function attachNewTaskHandler(button) {
      button.addEventListener('click', () => {
        const groupId = button.closest('.big-container').dataset.groupId;
        const smallList = button.closest('.big-container').querySelector('.small-list');
        if (groupId) {
          fetch(`/group/${groupId}/task/create/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ content: 'New Item' })
          })
          .then(r => r.json())
          .then(d => {
            if (d.success) {
              const newItem = document.createElement('li');
              newItem.innerHTML = `<input type="checkbox" class="task-checkbox"><span class="task-text">${d.task_content}</span>`;
              newItem.dataset.taskId = d.task_id;
              smallList.appendChild(newItem);
              attachTaskClickHandler(newItem);
              attachCheckboxHandler(newItem.querySelector('.task-checkbox'));
            }
          });
        } else {
          const newItem = document.createElement('li');
          newItem.innerHTML = `<input type="checkbox" class="task-checkbox"><span class="task-text">New Item</span>`;
          smallList.appendChild(newItem);
          attachTaskClickHandler(newItem);
        }
      });
    }

    document.querySelectorAll('.btn-add-new-todo').forEach(button => attachNewTaskHandler(button));

    document.getElementById('newGroup').addEventListener('click', () => {
      const groupCount = document.getElementById('bigSort').querySelectorAll('.big-container').length + 1;
      fetch(`/board/${boardId}/group/create/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ name: `Group ${groupCount}` })
      })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          const newBigContainer = document.createElement('div');
          newBigContainer.classList.add('big-container');
          newBigContainer.dataset.groupId = d.group_id;
          newBigContainer.innerHTML = `<h3>${d.group_name}<button class="btn-add-new-todo">new</button></h3><ul class="small-list"></ul>`;
          document.getElementById('bigSort').appendChild(newBigContainer);
          initSortableList(newBigContainer.querySelector('.small-list'));
          attachNewTaskHandler(newBigContainer.querySelector('.btn-add-new-todo'));
        }
      });
    });

    // Board settings modal handlers
    document.getElementById('editBoardBtn').addEventListener('click', () => {
      document.getElementById('boardNameInput').value = document.getElementById('boardName').textContent.trim().replace('✎', '').trim();
      document.getElementById('boardBgInput').value = '{{ board.background_image }}';
      document.getElementById('boardSettingsModal').classList.add('active');
    });

    document.getElementById('boardCancelBtn').addEventListener('click', () => {
      document.getElementById('boardSettingsModal').classList.remove('active');
    });

    document.getElementById('boardSaveBtn').addEventListener('click', () => {
      const name = document.getElementById('boardNameInput').value.trim();
      const bgImage = document.getElementById('boardBgInput').value.trim();
      
      fetch(`/board/${boardId}/update/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ name: name, background_image: bgImage })
      })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          const boardNameEl = document.getElementById('boardName');
          boardNameEl.childNodes[0].textContent = d.board_name;
          document.body.style.backgroundImage = `url(/static/${d.background_image})`;
          document.getElementById('boardSettingsModal').classList.remove('active');
        }
      });
    });
  </script>
{% endblock %}
